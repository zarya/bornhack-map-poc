<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BornHack Grid locator map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        .leaflet-popup-scrolled {
            border-bottom: unset!important;
            border-top: unset!important;
        }
        .leaflet-popup-content{
            max-height: 70vh;
            max-width: 70vw;
        }
        .leaflet-popup-content.media{
            width: auto!important;
            height: auto!important;
        }
        .leaflet-popup-content th {
            text-align: left;
            vertical-align: top;
            min-width: 75px;
        }
        .leaflet-popup-content td {
            min-width: 75px;
        }
        .leaflet-popup-content td img {
            max-height: 60vh;
            max-width: 60vw;
        }
    </style>
</head>
<body>
    <div height="30px">Selected grid:<span id="selectedGrid"></span> Center: <span id="selectedGridCenter"></span><br>
    <input id="grid"><button onClick="findGrid()">Find</Button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/processing.js"></script>
    <script src="js/map.js"></script>
    <script>
        function addClassToPopupIfMedia(content, popup) {
			var tempDiv = document.createElement('div');
			tempDiv.innerHTML = content;
			if (tempDiv.querySelector('td img')) {
				popup._contentNode.classList.add('media');
					setTimeout(function() {
						popup.update();
					}, 10);
			} else {
				popup._contentNode.classList.remove('media');
			}
		}

        const mapObject = new BHMap("map");
        const proc  = new Processing();
        const connectionOptions = {
            style: {
                opacity: 1,
                color: 'rgba(213,180,60,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 8.0,
                fillOpacity: 0,
                interactive: true,
            },
            onEachFeature: function(feature, layer) {
                const content = `${feature.properties['name']}<br>From: ${feature.properties['POP_A']}<br>To: ${feature.properties['POP_B']}`
                layer.bindPopup(content, { maxHeight: 400});
            }
        }
        const popOptions = {
            onEachFeature: function(feature, layer) {
                layer.on('click', function (e) {
                    console.log(e);
                });
                const content = `${feature.properties['name']}`
                layer.bindPopup(content, { maxHeight: 400});
            }
        }
        const photoOptions = {
            onEachFeature: function(feature, layer) {
                const content = `<table><tr><td colspan="2"><img src="https://gigafreak.net/bh2024/${feature.properties['name']}" /></td></tr></table>`
                layer.on('popupopen', function(e) {
                    addClassToPopupIfMedia(content, e.popup);
                });
                layer.bindPopup(content, { maxHeight: 400});
            },
            pointToLayer: function(feature, latlng) {
                return L.marker(latlng, {icon: new L.Icon({
                    iconUrl: 'img/photo.png',
                    iconSize: [25, 25],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })});
            },
        }

        mapObject.loadLayer("mqtt", {
            onEachFeature: function(_feature, layer) {
                layer.on('click', function (e) {
                    console.log(e);
                });          
            },
            pointToLayer: function(feature, latlng) {
                if (feature.properties.marker == "circle")
                    return new L.CircleMarker(latlng, {
                        radius: 25,
                        color: '#FF0000'
                    });
                else
                    return L.marker(latlng)
            },
            style: {
                color: "green",
                fillOpacity: 1.0,
                weight: 0.5
            }
        })

        mapObject.loadLayer("bh2025-noc-planning-pops", popOptions);
        mapObject.loadLayer("bh2024-noc-pops", popOptions);
        mapObject.loadLayer("bh2024-noc-connections", connectionOptions);
        mapObject.loadLayer("bh2022-noc-pops", popOptions, false);
        mapObject.loadLayer("bh2021-noc-pops", popOptions, false);
        mapObject.loadLayer("bh2019-noc-pops", popOptions, false);
        mapObject.loadLayer("bh2024-noc-pics", photoOptions);

        mapObject.onGridClick = function (e) {
            e.target.setStyle({fillOpacity: 1.0});
            let center = e.target.getCenter();
            document.getElementById('selectedGridCenter').innerHTML = center.lat + "," + center.lng;
            document.getElementById('selectedGrid').innerHTML = mapObject.cols[e.target.feature.properties.col_index - 2] + (e.target.feature.properties.row_index - 1);
            document.getElementById('grid').value = "";
        }

        function findGrid () {
            const grid = document.getElementById('grid').value;
            if (grid.includes(",")) {
                findGridLoc(grid); 
            } else {
                findGridName(grid);
            }
        }

        function findGridName(grid) {
            const layer = mapObject.findGridName(grid);
            let center = layer.getCenter();
            document.getElementById('selectedGridCenter').innerHTML = center.lat + "," + center.lng;
            document.getElementById('selectedGrid').innerHTML = document.getElementById('grid').value;
            layer.setStyle({fillOpacity: 1.0});
        }
        
        function findGridLoc(grid) {
            const layer = mapObject.findGridLoc(grid.split(",")[0], grid.split(",")[1]);
            let center = layer.getCenter();
            document.getElementById('selectedGridCenter').innerHTML = center.lat + "," + center.lng;
            document.getElementById('selectedGrid').innerHTML = mapObject.cols[layer.feature.properties.col_index - 2] + (layer.feature.properties.row_index - 1);
            layer.setStyle({fillOpacity: 1.0});
        }
    </script>
    <script src="js/mqtt.js"></script>
</body>
</html>
